var CircleAudioPlayerSkins=CircleAudioPlayerSkins||{};
CircleAudioPlayerSkins.prototype=$.extend(CircleAudioPlayerSkins,{plane:{outerCircle:{color:"rgba(0,0,0,0)"},progressBar:{loadColor:"rgba(178,230,23,1)",fillColor:"#0095DA"},innerCircle:{color:"#F5F5F5",margin:15},buttons:{playColor:"#666666",playHoverColor:"#0095DA",pauseColor:"#666666",pauseHoverColor:"#0095DA",soundLed:{color:"#666666",size:1}}},black:{outerCircle:{color:"gradient:linear:#585858:#A6A6A6"},progressBar:{loadColor:"rgba(255, 255, 255, 0.7)",fillColor:"gradient:radial:distribute-0,0.733,0.991:rgba(255, 238, 40, 1.000):rgba(130, 194, 238, 1.000):rgba(40, 40, 40, 1.000)",
margin:20,shadow:{type:"inner"}},innerCircle:{color:"gradient:radial:#7f7f7f:#474646",margin:35,shadow:{type:"outer"}},buttons:{playColor:"#666666",playHoverColor:"#0095DA",pauseColor:"#666666",pauseHoverColor:"#0095DA",soundLed:{color:"#00ff00",size:1}}},green:{outerCircle:{color:"gradient:linear:#005400:#008000"},progressBar:{loadColor:"rgba(255, 255, 255, 0.4)",fillColor:"gradient:radial:rgba(0, 128, 0, 1.000):rgba(0, 84, 0, 1.000)",margin:20,shadow:{type:"inner"}},innerCircle:{color:"gradient:radial:#008000:#005400",
margin:35,shadow:{type:"outer"}},buttons:{playColor:"#005400",playHoverColor:"#44ce44",pauseColor:"#005400",pauseHoverColor:"#44ce44",soundLed:{color:"#00ff00",size:1}}}});CircleAudioPlayerSkins={defaultSkin:{outerCircle:{color:"gradient:linear:#f5f5f5:#e8e8e8"},progressBar:{loadColor:"rgba(255, 255, 255, 0.7)",fillColor:"gradient:linear:rgba(255, 110, 2, 1.000):rgba(255, 255, 0, 1.000):rgba(255, 109, 0, 1.000)",margin:20,shadow:{type:"inner"}},innerCircle:{color:"gradient:linear:#ececec:#d4d4d4",margin:35,shadow:{type:"outer"}},buttons:{playColor:"#666666",playHoverColor:"#00ff00",pauseColor:"#666666",pauseHoverColor:"#ff0000",soundLed:{color:"#666666",size:1}}}};
(function(d){var h={radius:100,skin:"defaultSkin"},g=function(a,b){this.id=this._guid();this.element=d(a);this.options=d.extend({},h,b);this.radius=100;this.scale=1;this.diameter=2*this.radius;this.played=this.loaded=0;this.is_dragged=this.is_mousedown=this.is_mouseover=!1;this.ctx=this.canvas=this.prev_pt=this.start_pt=null;this.init()};g.prototype={constructor:g,config:{skins:CircleAudioPlayerSkins},init:function(){this._create();this._bindEvents();this.render()},getSkin:function(){return this.config.skins[this.options.skin]},
_guid:function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},_create:function(){this.canvas=d("<canvas></canvas>").attr("width",this.diameter+"px").attr("height",this.diameter+"px").css({width:this.diameter+"px",height:this.diameter+"px",cursor:"pointer","user-select":"none","-webkit-user-select":"none","-moz-user-select":"none"});this.ctx=this.canvas[0].getContext("2d");if(this.options.radius!=this.radius){var a=
this.options.radius/this.radius;this.scale=a;this.canvas.attr("width",this.diameter*a+"px").attr("height",this.diameter*a+"px").width(this.diameter*a).height(this.diameter*a);this.ctx.scale(a,a)}this.element.after(this.canvas).hide()},_bindEvents:function(){this.element.on("progress",this._onProgress);this.element.on("timeupdate",this._onTimeUpdate);this.element.on("canplay",this._onProgress);var a=this;this.canvas.hover(function(){a.is_mouseover=!0;a.render()},function(){a.is_mouseover=!1;a.render()});
this.canvas.on("mousedown touchstart MSPointerDown",function(b){a.is_mousedown=!0;a.prev_pt=a.start_pt=a._getMousePos(b)});this.canvas.on("mousemove touchmove MSPointerMove",function(b){a._onMove(b)});this.canvas.on("mouseup touchend MSPointerUp",function(b){a._onClick(b)})},_onProgress:function(a){a=d(this).data("circle-audio-player");var b=this.duration;try{var c=this.buffered.end(this.buffered.length-1);a.loaded=c/b;a.render()}catch(e){}},_onTimeUpdate:function(a){a=d(this).data("circle-audio-player");
a.played=this.currentTime/this.duration;a.render()},_onMove:function(a){this.getSkin();if(this.is_mousedown){this.is_dragged=!0;var b=this.element[0];a=this._getMousePos(a);var c=this._getMouseAngle(this.prev_pt),e=this._getMouseAngle(a);try{b.volume=c>e?.01<=b.volume?b.volume-=.01:0:.99>=b.volume?b.volume+=.01:1}catch(d){}this.prev_pt=a;this.render()}},_onClick:function(a){a=this._getMousePos(a);var b=this.getSkin(),c=b.progressBar.margin?b.progressBar.margin:0;this._inRadius(this.radius,this.radius,
a.x,a.y,this.radius-(b.innerCircle.margin?b.innerCircle.margin:0))?this.is_dragged||(b=this.element[0],b.paused?b.play():b.pause()):this._inRadius(this.radius,this.radius,a.x,a.y,this.radius-c)&&(b=this.element[0],a=Math.atan2(a.y-this.radius,a.x-this.radius),0>a&&(a=6+a),this.played=a/6,b.currentTime=b.duration*this.played);this.is_dragged=this.is_mousedown=!1;this.render()},render:function(){var a=this.getSkin();this.ctx.clearRect(0,0,this.diameter,this.diameter);this._drawCircle(a.outerCircle);
this._drawProgressBar(a.progressBar);this._drawCircle(a.innerCircle);this._drawButton()},_parseColor:function(a,b,c){c*=2;if(a.match(/^gradient/)){a=a.split(":");b="radial"==a[1]?this.ctx.createRadialGradient(b,b,0,b,b,b):this.ctx.createLinearGradient(0,0,c,c);var e=2;if(a[2].match(/^distribute/)){e=3;c=0;for(var d=a[2].replace(/^distribute-/,"").split(",");e<a.length;e++){var f=parseFloat(d[c++],10);b.addColorStop(f,a[e])}}else for(f=1/(a.length-3),c=0;e<a.length;e++)b.addColorStop(c,a[e]),c+=f;
return b}return a},_drawCircle:function(a){this.ctx.save();var b=this.radius,c=this.radius;a.margin&&(b-=a.margin);if(a.color){var e=a.angle?a.angle*Math.PI*2:2*Math.PI;this.ctx.beginPath();this.ctx.moveTo(c,c);this.ctx.arc(c,c,b,0,e,!1);this.ctx.fillStyle=this._parseColor(a.color,c,b);this.ctx.closePath();a.shadow&&"outer"==a.shadow.type&&(this.ctx.lineWidth=0,this.ctx.shadowBlur=(a.shadow.blur?a.shadow.blur:5)*this.scale,this.ctx.shadowColor=a.shadow.color?a.shadow.color:"rgba(0, 0, 0, 0.6)",this.ctx.shadowOffsetX=
0,this.ctx.shadowOffsetY=0);this.ctx.fill()}a.shadow&&"inner"==a.shadow.type&&(this.ctx.beginPath(),this.ctx.arc(c,c,b,0,2*Math.PI,!1),this.ctx.clip(),this.ctx.beginPath(),this.ctx.strokeStyle="#000000",this.ctx.lineWidth=a.shadow.width?a.shadow.width:5,this.ctx.shadowBlur=(a.shadow.blur?a.shadow.blur:5)*this.scale,this.ctx.shadowColor=a.shadow.color?a.shadow.color:"rgba(0, 0, 0, 0.6)",this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.arc(c,c,b+3,0,2*Math.PI,!1),this.ctx.stroke());this.ctx.restore()},
_drawProgressBar:function(a){0<this.loaded&&this._drawCircle({color:a.loadColor,angle:this.loaded,margin:a.margin});0<this.played&&this._drawCircle({color:a.fillColor,angle:this.played,margin:a.margin});this._drawCircle(a)},_drawButton:function(){var a=this.getSkin(),b=a.buttons;this.ctx.save();var c=this.radius,e=this.element[0],d=!e.paused,f=d?"\u2759\u2759":"\u25ba",g=d?0:5;this.ctx.save();this.ctx.font="normal bold 50px arial";this.ctx.textAlign="center";this.ctx.textBaseline="middle";this.ctx.fillStyle=
this._parseColor(d?this.is_mouseover?b.pauseHoverColor:b.pauseColor:this.is_mouseover?b.playHoverColor:b.playColor,c,c);this.ctx.fillText(f,c+g,c);f="\u00b7";c=c-(a.innerCircle.margin?a.innerCircle.margin:0)-5/this.scale;this.ctx.font="normal bold "+(b.soundLed.size?3<b.soundLed.size?3:b.soundLed.size:1)/this.scale*20+"px sans serif";this.ctx.textAlign="center";this.ctx.textBaseline="middle";e=180*e.volume;a=this.radius+Math.cos(e*Math.PI/180)*c;e=this.radius+Math.sin(e*Math.PI/180)*c;this.ctx.fillStyle=
this._parseColor(b.soundLed.color,c,c);this.ctx.fillText(f,a,e);this.ctx.restore()},_inRadius:function(a,b,c,e,d){return Math.sqrt((c-a)*(c-a)+(e-b)*(e-b))<d},_getMousePos:function(a){if(a.touches&&1<a.touches.length){var b=a.touches[0].offsetX;a=a.touches[0].offsetY}else b=a.offsetX,a=a.offsetY;b/=this.scale;a/=this.scale;return{x:b,y:a}},_getMouseAngle:function(a){a=180*Math.atan2(a.y-this.radius,a.x-this.radius)/Math.PI;0>a&&(a=360+a);return a}};d.fn.circleAudioPlayer=function(){d(this).each(function(){var a=
d(this).data("radius")?d(this).data("radius"):100,b=d(this).data("skin")?d(this).data("skin"):"default",a=new g(d(this)[0],{radius:a,skin:b});d(this).data("circle-audio-player",a)})};d(function(){d("[data-circle-audio-player]").circleAudioPlayer()})})(jQuery);
